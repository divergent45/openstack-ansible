---
- hosts: base_hw_prep_for_openstack
  vars_files: 
    - base-hardware-prep-defination.yml    
  become: true
  
  roles:
   - role: configure-proxy-apt
     when: "ansible_hostname not in  haproxy_server_hostnames" 
   - role: configure-chrony
   - role: install-apt-pkg   
   - role: configure-nfs-server
     when: "ansible_hostname  in nfs_server_hostnames"
   - role: configure-iommu-for-nova-compute
     when: "ansible_hostname in  nova_compute_server_hostnames"
   - role: create-interfaces-bridges
   - role: reboot-servers
    # when: "ansible_hostname in servers_to_reboot"
  tasks: 
  - name: Rebooting  the server  ----watch out you may disconnected if configuration is not proper
    shell: sleep 2 && shutdown -r now
    async: 1
    poll: 0
    ignore_errors: true
    when: "ansible_hostname in servers_to_reboot"
  - name: waiting for server to come back after reboot
    local_action: wait_for host={{ ansible_ssh_host }} state=started port=22 delay=120 timeout=300 connect_timeout=15
    retries: 50
#
